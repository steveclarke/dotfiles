#!/usr/bin/env bash

set -e -o pipefail

# Get dotfiles directory
if [[ -f "${HOME}/.dotfilesrc" ]]; then
  source "${HOME}/.dotfilesrc"
else
  DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
fi

SKILLS_DIR="${DOTFILES_DIR}/ai/skills"
STAGING_DIR="${DOTFILES_DIR}/configs/claude/.claude/skills"

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Show usage
show_usage() {
  echo "Usage: skills-link [command] [skill]"
  echo ""
  echo "Commands:"
  echo "  list           List all available skills"
  echo "  linked         List currently linked skills"
  echo "  link <skill>   Link a skill to Claude Code/Cursor"
  echo "  unlink <skill> Unlink a skill from Claude Code/Cursor"
  echo "  link-all       Link all available skills"
  echo "  unlink-all     Unlink all skills"
  echo ""
  echo "Examples:"
  echo "  skills-link list"
  echo "  skills-link link todoist-daily-review"
  echo "  skills-link unlink todoist-daily-review"
}

# List all available skills
list_skills() {
  echo -e "${BLUE}Available skills in ai/skills/:${NC}"
  echo ""
  
  if [[ ! -d "$SKILLS_DIR" ]]; then
    echo -e "  ${RED}Error: Skills directory not found: ${SKILLS_DIR}${NC}"
    exit 1
  fi
  
  for skill_dir in "${SKILLS_DIR}"/*; do
    if [[ -d "$skill_dir" ]]; then
      basename_skill=$(basename "$skill_dir")
      
      # Skip README.md if it's a file
      if [[ "$basename_skill" == "README.md" ]]; then
        continue
      fi
      
      # Check if SKILL.md exists
      if [[ ! -f "${skill_dir}/SKILL.md" ]]; then
        echo -e "  ${RED}✗${NC} ${basename_skill} (missing SKILL.md)"
        continue
      fi
      
      # Check if linked
      if [[ -L "${STAGING_DIR}/${basename_skill}" ]]; then
        echo -e "  ${GREEN}✓${NC} ${basename_skill}"
      else
        echo -e "  ${YELLOW}○${NC} ${basename_skill}"
      fi
    fi
  done
  
  echo ""
  echo -e "${GREEN}✓${NC} = Linked  ${YELLOW}○${NC} = Not linked"
}

# List currently linked skills
list_linked() {
  echo -e "${BLUE}Currently linked skills:${NC}"
  echo ""
  
  if [[ ! -d "$STAGING_DIR" ]]; then
    echo "  No skills currently linked"
    echo ""
    return 0
  fi
  
  local count=0
  for link in "${STAGING_DIR}"/*; do
    if [[ -L "$link" ]]; then
      basename_link=$(basename "$link")
      target=$(readlink "$link")
      echo -e "  ${GREEN}✓${NC} ${basename_link} → ${target}"
      ((count++))
    fi
  done
  
  if [[ $count -eq 0 ]]; then
    echo "  No skills currently linked"
  fi
  
  echo ""
}

# Link a skill
link_skill() {
  local skill_name="$1"
  
  if [[ -z "$skill_name" ]]; then
    echo -e "${RED}Error: Please specify a skill to link${NC}"
    echo "Example: skills-link link todoist-daily-review"
    exit 1
  fi
  
  local source_dir="${SKILLS_DIR}/${skill_name}"
  local target_link="${STAGING_DIR}/${skill_name}"
  
  # Check if source directory exists
  if [[ ! -d "$source_dir" ]]; then
    echo -e "${RED}Error: Skill '${skill_name}' not found in ai/skills/${NC}"
    exit 1
  fi
  
  # Check if SKILL.md exists
  if [[ ! -f "${source_dir}/SKILL.md" ]]; then
    echo -e "${RED}Error: Skill '${skill_name}' is missing SKILL.md${NC}"
    exit 1
  fi
  
  # Create staging directory if it doesn't exist
  mkdir -p "$STAGING_DIR"
  
  # Check if already linked
  if [[ -L "$target_link" ]]; then
    echo -e "${YELLOW}Already linked: ${skill_name}${NC}"
    exit 0
  fi
  
  # Check if target exists as a real directory (not symlink)
  if [[ -d "$target_link" ]] && [[ ! -L "$target_link" ]]; then
    echo -e "${RED}Error: ${target_link} exists as a directory (not a symlink)${NC}"
    echo "Please remove it manually before linking"
    exit 1
  fi
  
  # Create the symlink (relative path: ../../../../ai/skills/skill-name)
  cd "$STAGING_DIR" || exit 1
  ln -s "../../../../ai/skills/${skill_name}" "${skill_name}"
  cd - > /dev/null || exit 1
  
  echo -e "${GREEN}✓${NC} Linked: ${skill_name}"
}

# Unlink a skill
unlink_skill() {
  local skill_name="$1"
  
  if [[ -z "$skill_name" ]]; then
    echo -e "${RED}Error: Please specify a skill to unlink${NC}"
    echo "Example: skills-link unlink todoist-daily-review"
    exit 1
  fi
  
  local target_link="${STAGING_DIR}/${skill_name}"
  
  # Check if link exists
  if [[ ! -L "$target_link" ]]; then
    echo -e "${YELLOW}Not linked: ${skill_name}${NC}"
    exit 0
  fi
  
  # Remove the symlink
  rm -f "$target_link"
  
  echo -e "${GREEN}✓${NC} Unlinked: ${skill_name}"
}

# Link all skills
link_all() {
  echo -e "${BLUE}Linking all skills...${NC}"
  echo ""
  
  if [[ ! -d "$SKILLS_DIR" ]]; then
    echo -e "${RED}Error: Skills directory not found: ${SKILLS_DIR}${NC}"
    exit 1
  fi
  
  # Create staging directory if it doesn't exist
  mkdir -p "$STAGING_DIR"
  
  local linked_count=0
  local skipped_count=0
  
  for skill_dir in "${SKILLS_DIR}"/*; do
    if [[ -d "$skill_dir" ]]; then
      basename_skill=$(basename "$skill_dir")
      
      # Skip if SKILL.md doesn't exist
      if [[ ! -f "${skill_dir}/SKILL.md" ]]; then
        echo -e "${YELLOW}Skipping ${basename_skill} (missing SKILL.md)${NC}"
        ((skipped_count++))
        continue
      fi
      
      # Try to link (will skip if already linked)
      if [[ -L "${STAGING_DIR}/${basename_skill}" ]]; then
        echo -e "${YELLOW}Already linked: ${basename_skill}${NC}"
        ((skipped_count++))
      else
        link_skill "$basename_skill"
        ((linked_count++))
      fi
    fi
  done
  
  echo ""
  echo -e "${GREEN}Done!${NC} Linked: ${linked_count}, Skipped: ${skipped_count}"
}

# Unlink all skills
unlink_all() {
  echo -e "${BLUE}Unlinking all skills...${NC}"
  echo ""
  
  if [[ ! -d "$STAGING_DIR" ]]; then
    echo "  No skills currently linked"
    echo ""
    return 0
  fi
  
  local unlinked_count=0
  
  for link in "${STAGING_DIR}"/*; do
    if [[ -L "$link" ]]; then
      basename_link=$(basename "$link")
      unlink_skill "$basename_link"
      ((unlinked_count++))
    fi
  done
  
  if [[ $unlinked_count -eq 0 ]]; then
    echo "  No skills to unlink"
  fi
  
  echo ""
  echo -e "${GREEN}Done!${NC}"
}

# Main command handler
if [[ $# -eq 0 ]]; then
  show_usage
  exit 1
fi

case "$1" in
  list)
    list_skills
    ;;
  linked)
    list_linked
    ;;
  link)
    link_skill "$2"
    ;;
  unlink)
    unlink_skill "$2"
    ;;
  link-all)
    link_all
    ;;
  unlink-all)
    unlink_all
    ;;
  *)
    echo -e "${RED}Invalid command: $1${NC}"
    echo ""
    show_usage
    exit 1
    ;;
esac
